name: Build and Release

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master
      - develop
      - development
    paths-ignore:
      - README.md

concurrency:
  group: winbox-linux-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build AppImage
        shell: bash
        run: |
          set -euo pipefail

          WINBOX_PAGE="https://mikrotik.com/download/winbox"

          # Pull latest version + Linux SHA256 from MikroTik download page
          python3 - <<'PY'
          import re, sys, urllib.request

          url = "https://mikrotik.com/download/winbox"
          html = urllib.request.urlopen(url).read().decode("utf-8", "replace")

          # Version is shown like: #### v4.0beta44
          mver = re.search(r"####\s*v(4\.[0-9A-Za-z]+)", html)
          if not mver:
            print("Failed to detect WinBox v4 version from page", file=sys.stderr)
            sys.exit(1)
          ver = mver.group(1)

          # Linux SHA256 is shown in the Linux block. We anchor around "Linux (64-bit)" then find a 64-hex hash.
          linux_block = re.search(r"Linux\s*\(64-bit\).*?SHA256\s*([0-9a-f]{64})", html, re.IGNORECASE | re.DOTALL)
          if not linux_block:
            print("Failed to detect Linux SHA256 from page", file=sys.stderr)
            sys.exit(1)
          sha = linux_block.group(1).lower()

          print(f"WINBOX_VERSION={ver}")
          print(f"WINBOX_SHA256={sha}")
          PY

          # Export vars from the python output
          eval "$(python3 - <<'PY'
          import re, sys, urllib.request
          html = urllib.request.urlopen("https://mikrotik.com/download/winbox").read().decode("utf-8", "replace")
          ver = re.search(r"####\s*v(4\.[0-9A-Za-z]+)", html).group(1)
          sha = re.search(r"Linux\s*\(64-bit\).*?SHA256\s*([0-9a-f]{64})", html, re.IGNORECASE | re.DOTALL).group(1).lower()
          print(f'echo "WINBOX_VERSION={ver}"')
          print(f'echo "WINBOX_SHA256={sha}"')
          PY
          )"

          echo "Detected WinBox version: ${WINBOX_VERSION}"
          echo "Detected Linux SHA256:   ${WINBOX_SHA256}"

          URL="https://download.mikrotik.com/routeros/winbox/${WINBOX_VERSION}/WinBox_Linux.zip"
          curl -fsSL "$URL" -o WinBox_Linux.zip
          echo "${WINBOX_SHA256}  WinBox_Linux.zip" | sha256sum -c -

          mkdir -p unpack
          unzip -q WinBox_Linux.zip -d unpack

          docker run --rm \
            -v "${PWD}:/project" -w /project \
            appimagecrafters/appimage-builder:latest \
            appimage-builder --skip-test --recipe appimage-builder.yml

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          echo "WINBOX_VERSION=$WINBOX_VERSION" >> $GITHUB_ENV
          git tag $WINBOX_VERSION $GITHUB_SHA
          git push origin $WINBOX_VERSION

      - name: Upload AppImage to Release
        uses: meeDamian/github-release@2.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ env.WINBOX_VERSION }}
          files: "*.AppImage"
          gzip: false
          allow_override: true