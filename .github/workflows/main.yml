name: Build and Release

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master
      - develop
      - development
    paths-ignore:
      - README.md
      - appimage-builder.yml

concurrency:
  group: winbox-linux-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Build AppImage
        shell: bash
        run: |
          set -euo pipefail

          source <(python3 ./version.py)
          echo "Detected WinBox version: ${WINBOX_VERSION}"
          echo "Detected Linux SHA256:   ${WINBOX_SHA256}"

          URL="https://download.mikrotik.com/routeros/winbox/${WINBOX_VERSION}/WinBox_Linux.zip"
          curl -fsSL "$URL" -o WinBox_Linux.zip
          echo "${WINBOX_SHA256}  WinBox_Linux.zip" | sha256sum -c -

          mkdir -p unpack
          unzip -q WinBox_Linux.zip -d unpack

          sed -i '0,/^[[:space:]]*version:[[:space:]]*".*"/s//    version: "'"$WINBOX_VERSION"'"/' appimage-builder.yml
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          if ! git diff --quiet -- appimage-builder.yml; then
            git config user.name "github-actions"
            git config user.email "github-actions@github.com"
            git add appimage-builder.yml
            git commit -m "chore: bump AppImage version to ${WINBOX_VERSION}"
            git push origin "HEAD:${GITHUB_REF_NAME}"
          else
            echo "No version change; skipping commit."
          fi

          docker run --rm \
            -v "${PWD}:/project" -w /project \
            appimagecrafters/appimage-builder:latest \
            appimage-builder --skip-test --recipe appimage-builder.yml

          echo "WINBOX_VERSION=$WINBOX_VERSION" >> $GITHUB_ENV

          if git rev-parse "$WINBOX_VERSION" >/dev/null 2>&1; then
            echo "Tag $WINBOX_VERSION already exists, skipping tag creation"
          else
            git tag $WINBOX_VERSION $GITHUB_SHA
            git push origin $WINBOX_VERSION
          fi

      - name: Upload AppImage to Release
        uses: meeDamian/github-release@2.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ env.WINBOX_VERSION }}
          files: "*.AppImage"
          gzip: false
          allow_override: true
