name: Build and Release

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master
      - develop
      - development
    paths-ignore:
      - README.md

concurrency:
  group: winbox-linux-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build AppImage
        shell: bash
        run: |
          set -euo pipefail

          source <(python3 ./version.py)
          echo "Detected WinBox version: ${WINBOX_VERSION}"
          echo "Detected Linux SHA256:   ${WINBOX_SHA256}"

          URL="https://download.mikrotik.com/routeros/winbox/${WINBOX_VERSION}/WinBox_Linux.zip"
          curl -fsSL "$URL" -o WinBox_Linux.zip
          echo "${WINBOX_SHA256}  WinBox_Linux.zip" | sha256sum -c -

          mkdir -p unpack
          unzip -q WinBox_Linux.zip -d unpack

          docker run --rm \
            -v "${PWD}:/project" -w /project \
            appimagecrafters/appimage-builder:latest \
            appimage-builder --skip-test --recipe appimage-builder.yml

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          echo "WINBOX_VERSION=$WINBOX_VERSION" >> $GITHUB_ENV
          git tag $WINBOX_VERSION $GITHUB_SHA
          git push origin $WINBOX_VERSION

      - name: Upload AppImage to Release
        uses: meeDamian/github-release@2.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ env.WINBOX_VERSION }}
          files: "*.AppImage"
          gzip: false
          allow_override: true